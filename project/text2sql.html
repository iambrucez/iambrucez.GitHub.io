<!DOCTYPE html><html lang="en" class="__className_6b8127"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/2b3f1035ed87a788-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/projects/thumbnail/text2sql.png"/><link rel="preload" as="image" href="/projects/text2sql/prompt_design.png"/><link rel="preload" as="image" href="/projects/text2sql/f1.png"/><link rel="stylesheet" href="/_next/static/css/2c8f6a03b5c2a59f.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/2a1054080b77ae12.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/eea751ee46d1e33b.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-7dba2dcc1d41e4e6.js"/><script src="/_next/static/chunks/fd9d1056-6184565b3c21c232.js" async=""></script><script src="/_next/static/chunks/23-1950a167b2ff5a82.js" async=""></script><script src="/_next/static/chunks/main-app-57dd34352df4a0d5.js" async=""></script><script src="/_next/static/chunks/291-de708f65a06c2e3a.js" async=""></script><script src="/_next/static/chunks/app/project/layout-0ad3d92cc6aca70e.js" async=""></script><script src="/_next/static/chunks/app/layout-2fb9a46769555ecd.js" async=""></script><title>Yufan Zhang</title><meta name="description" content="Yufan Zhang&#x27;s personal website"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body><main class="mainPage_main__MhBEv"><div class="navbar_navbar__GSgRc"><div class="navbar_navbarLeft__KMVRO"><p class="navbar_logo__YN5V1"><a href="/">YUFAN <span class="navbar_bruce__FklTV">(BRUCE)</span></a></p></div><div class="navbar_navbarRight__h780S"><div class="navbar_navLinks__iKcrL"><a href="/"><p class="navbar_homeInactive__hkNpL">Home</p></a><a href="/projects"><p class="navbar_projectsActive__2W2Sa">Projects</p></a><a href="/gallery"><p class="navbar_photographyInactive__f_Pc7">Gallery</p></a><a href="/about"><p class="navbar_resumeInactive__7maxx">About</p></a></div></div></div><div class="mainPage_titleContainer__wAUr9"><h1>Text-to-SQL Translation with LLMs</h1></div><div class="mainPage_contentContainer__vSAP1"><div class="detail_mainContainer__Tql_C"><div class="detail_infoContainer__K_uh5"><p>2024</p><p>deep learning / nlp</p></div><div class="detail_thumbnailContainer__WozO_"><img src="/projects/thumbnail/text2sql.png" alt="text2sql"/></div><div class="detail_contentContainer__h8PK1"><blockquote>
<p>&quot;Hmm, I wonder how LLMs can be used to translate natural language instructions into SQL queries. ðŸ¤”&quot;</p>
</blockquote>
<p><a href="https://github.com/iamyufan/text2sql">[GitHub Repo]</a>
<a href="https://colab.research.google.com/drive/1taPVOrJ13UC4vnqTlMaJDrCXZYhjItHb#scrollTo=FZlMYp5PTYDE">[Colab]</a></p>
<hr/>
<h2>Introduction</h2>
<p>Writing SQL queries to solve analytical and business-critical questions is a common task for data analysts and data scientists. However, writing SQL queries can be challenging for those who are not familiar with SQL syntax. In this project, I aim to explore different solutions to the task of translating natural language instructions into SQL queries. Specifically, I experimented with three different approaches:</p>
<ol>
<li>Fine-tuning a pre-trained encoder-decoder transformer model, the <a href="https://huggingface.co/docs/transformers/en/model_doc/t5">T5 model</a>.</li>
<li>Training a model with the same architecture from scratch.</li>
<li>Using diverse prompt engineering techniques with a large language model (LLM).</li>
</ol>
<h2>Dataset</h2>
<p>For this project, I used a dataset consisting of natural language instructions and their corresponding SQL queries, which target the <a href="https://github.com/iamyufan/text2sql/blob/main/data/flight_database.db"><code>flight_database.db</code></a>. The database schema, outlined in the <a href="https://github.com/iamyufan/text2sql/blob/main/data/flight_database.schema"><code>flight_database.schema</code></a> file, includes 25 tables such as &quot;airline,&quot; &quot;restriction,&quot; and &quot;flight.&quot; Each table&#x27;s schema details the columns, their types, and whether they are indexed.</p>
<p>The text-to-SQL data is divided into training, development, and held-out test sets. Each natural language instruction (in <code>.nl</code> files) is paired with a ground-truth SQL query (in <code>.sql</code> files). Here are some examples from the training set:</p>
<ul>
<li>
<p><strong>Natural Language Instruction:</strong> List all the flights that arrive at General Mitchell International from various cities.</p>
<p><strong>SQL Query:</strong></p>
<pre><code class="language-sql">SELECT DISTINCT
    flight_1.flight_id
FROM
    flight flight_1,
    airport airport_1,
    airport_service airport_service_1,
    city city_1
WHERE
    flight_1.to_airport = airport_1.airport_code
    AND airport_1.airport_code = &#x27;MKE&#x27;
    AND flight_1.from_airport = airport_service_1.airport_code
    AND airport_service_1.city_code = city_1.city_code
</code></pre>
</li>
<li>
<p><strong>Natural Language Instruction:</strong> How much is a first-class ticket from Boston to San Francisco?</p>
<p><strong>SQL Query:</strong></p>
<pre><code class="language-sql">SELECT DISTINCT
    fare_1.fare_id
FROM
    fare fare_1,
    fare_basis fare_basis_1,
    flight_fare flight_fare_1,
    flight flight_1,
    airport_service airport_service_1,
    city city_1,
    airport_service airport_service_2,
    city city_2
WHERE
    fare_1.fare_basis_code = fare_basis_1.fare_basis_code
    AND fare_basis_1.class_type = &#x27;FIRST&#x27;
    AND fare_1.fare_id = flight_fare_1.fare_id
    AND flight_fare_1.flight_id = flight_1.flight_id
    AND flight_1.from_airport = airport_service_1.airport_code
    AND airport_service_1.city_code = city_1.city_code
    AND city_1.city_name = &#x27;BOSTON&#x27;
    AND flight_1.to_airport = airport_service_2.airport_code
    AND airport_service_2.city_code = city_2.city_code
    AND city_2.city_name = &#x27;SAN FRANCISCO&#x27;
</code></pre>
</li>
</ul>
<p>To evaluate the models, I compared the generated SQL queries with the ground-truth queries using the F1 metric to ensure they return the same database records.</p>
<h2>Methods</h2>
<h3>Working with the T5 Architecture</h3>
<p>I will be working with the small variant of the <a href="https://arxiv.org/abs/1910.10683">T5 encoder-decoder architecture</a> (Raffel et al., 2019). The encoder will ingest natural language queries (i.e., the input sequence) while the decoder will predict the corresponding SQL queries (i.e., the output sequence). My first task will be to finetune the pretrained T5 architecture while your second task will be to train the exact same architecture from scratch (i.e., from randomly initialized weights).</p>
<p>For either task, I expect simply implementing data processing with the existing T5 tokenizer and varying simple hyperparameters should lead to good baseline results. During finetuning, a common design choice is to freeze part of the model parameters (i.e., only finetune a subset of the parameters).</p>
<p>Here are some design choices I have made to get the best-performing fine-tuned T5 model:</p>
<ul>
<li><strong>Tokenization</strong>: Utilized the Hugging Face T5 tokenizer (&quot;google-t5/t5-small&quot;) with padding and truncation enabled to ensure consistent batch processing.</li>
<li><strong>Architecture</strong>: Only the decoder&#x27;s parameters were updated during fine-tuning, with the encoder&#x27;s parameters frozen to preserve pre-learned contextual representations.</li>
<li><strong>Hyperparameters</strong>: Trained using a batch size of 16, across 20 epochs, with an AdamW optimizer set to a learning rate of 5e-5.</li>
</ul>
<p>Similarly, here are the design choices I have made to train the T5 model from scratch:</p>
<ul>
<li><strong>Tokenization</strong>: Used the same Hugging Face T5 tokenizer (&quot;google-t5/t5-small&quot;) with padding and truncation enabled for uniform input and output processing.</li>
<li><strong>Hyperparameters</strong>: Configured with a batch size of 16, trained over 50 epochs, using an AdamW optimizer with a learning rate of 5e-5.</li>
</ul>
<h3>Task 3: Prompting &amp; In-context Learning with Large Language Models</h3>
<p>For this task, I have experimented with in-context learning (ICL) using an LLM. I used the instruction-tuned Gemma 1.1 2B model. The LLM is frozen here, and will perform the generation task while only conditioned on the text input (prompt). I need to design prompts to experiment with zero- and few-shot prompting. In the zero-shot case, I provided instructions in the prompt, but it doesnâ€™t include examples that show the intended behaviour. In the few-shot case, I also included examples showing the intented behaviour. I have experimented with different value of <code>k</code>, which is the number of examples. For few-shot prompting, I also need to experiment with different ways of selecting the examples, observe how the design choice affects the performance, and how sensitive performance is to the selection of ICL examples. In the prompt, whether to also provide additional context and indications is also worth a try, for instance, about the task, the database, or details about the intended behavior.</p>
<p>Here is how I have designed the prompts for the zero-shot and few-shot prompting:</p>
<p><img src="/projects/text2sql/prompt_design.png" alt="Prompt Design"/></p>
<h4>How to select the examples for few-shot prompting?</h4>
<p>For selecting the examples when ( k &gt; 0 ) in my few-shot prompting, I employed a straightforward random selection approach. This method involves choosing ( k ) distinct example pairs randomly from the training dataset. Each pair consists of a natural language instruction and its corresponding SQL query.</p>
<h2>Evaluation</h2>
<h3>LLM Prompting</h3>
<p>I have experimented with different value (0, 1, 3) of <code>k</code> in the few-shot prompting strategy to evaluate the effectiveness of the prompts in guiding the model to generate accurate SQL queries.</p>
<p>Besides experimenting with the number of examples, I have also conducted ablations to evaluate the impact of different components of the prompt on the model&#x27;s performance. The ablations are as follows:</p>
<ul>
<li>Prompting Variant 3: Removed the data schema. This experiment tested the necessity of explicitly giving the model the database schema include the table names and the column names.</li>
<li>Prompting Variant 4: Removed the instruction &quot;Using valid SQL, answer the following questions for the tables provided above. Please do not generate more information other than the SQL queries.&quot; This experiment tested the necessity of explicitly guiding the model to restrict its responses to SQL queries only.</li>
<li>Prompting Variant 5: Removed the markdown SQL block indicators (```sql and ```). This ablation tested whether these formatting markers impact the model&#x27;s ability to correctly format SQL queries.</li>
</ul>
<p>The results of these ablations are shown in the table below:</p>
<table><thead><tr><th>System</th><th>Query EM</th><th>F1 score</th></tr></thead><tbody><tr><td>Full model (<code>k = 0</code>)</td><td><strong>0.02789</strong></td><td><strong>0.19305</strong></td></tr><tr><td>Variant 1 (<code>k = 0</code>)</td><td>0.00000</td><td>0.11779</td></tr><tr><td>Variant 2 (<code>k = 3</code>)</td><td>0.00643</td><td>0.13350</td></tr><tr><td>Variant 3 (ablating the database schema)</td><td>0.00643</td><td>0.14559</td></tr><tr><td>Variant 4 (ablating the instruction sentence)</td><td>0.02361</td><td>0.17792</td></tr><tr><td>Variant 5 (ablating the formatting markers)</td><td>0.00643</td><td>0.14702</td></tr></tbody></table>
<p>For ICL, I also visualized the Record F1 on the development set that the model achieved with different values of <code>k</code>.</p>
<p><img src="/projects/text2sql/f1.png" alt="ICL Performance"/></p>
<h3>T5 Model</h3>
<p>The tables below shows the results of the fine-tuned T5 model and the T5 model trained from scratch:</p>
<p>Fine-tuned T5 model:</p>
<table><thead><tr><th>System</th><th>Query EM</th><th>F1 score</th></tr></thead><tbody><tr><td>Full model</td><td>0.01716</td><td>0.62742</td></tr><tr><td>Variant 1 (unfreeze the last layer)</td><td>0.01502</td><td>0.54246</td></tr></tbody></table>
<p>T5 model trained from scratch:</p>
<table><thead><tr><th>System</th><th>Query EM</th><th>F1 score</th></tr></thead><tbody><tr><td>Full model</td><td>0.02360</td><td>0.57552</td></tr><tr><td>Variant 1 (training for 20 epochs)</td><td>0.02145</td><td>0.48829</td></tr></tbody></table>
<h3>Results on the held-out test set</h3>
<p>The tables below show the results of the best-performing models on the held-out test set:</p>
<table><thead><tr><th>System</th><th>F1 score</th></tr></thead><tbody><tr><td>LLM with few-shot prompting (k = 3)</td><td>0.15003</td></tr><tr><td>Fine-tuned T5 model</td><td>0.61011</td></tr><tr><td>Trained T5 model from scratch</td><td>0.52191</td></tr></tbody></table>
<h3>Qualitative Error Analysis</h3>
<p>I have also conducted a qualitative error analysis to identify the types of errors made by the models. Here are some examples of the errors made by the models:</p>
<h4>Un-existing Column</h4>
<ul>
<li><strong>Relevent Models</strong>: All models</li>
<li><strong>Example</strong>: Column <code>departure_airport</code> does not exist:<!-- -->
<pre><code class="language-sql">SELECT * FROM flight WHERE departure_airport = &#x27;ORD&#x27; AND arrival_airport = &#x27;MCI&#x27; AND flight_date = &#x27;2023-06-17&#x27;
</code></pre>
</li>
<li><strong>Error Desciption</strong>: The model generates queries with columns that do not exist in the database schema.</li>
</ul>
<h4>Syntax Error</h4>
<ul>
<li><strong>Relevent Models</strong>: All models</li>
<li><strong>Example</strong>: One extra &quot;)&quot;:<!-- -->
<pre><code class="language-sql">... WHERE flight_1.from_airport = airport_service_1.airport_code AND ... AND( flight_1.arrival_time &gt;= 1600 ) AND( flight_1.flight_days = days_1.days_code ...
</code></pre>
</li>
<li><strong>Error Desciption</strong>: Syntax errors such as unmatched parentheses disrupt the SQL query structure, leading to execution failures.</li>
</ul>
<h4>Logic Error</h4>
<ul>
<li><strong>Relevent Models</strong>: All models</li>
<li><strong>Example</strong>:
Natural language text: &quot;What flights are available tomorrow from Denver to Philadelphia?&quot;
Generated:<!-- -->
<pre><code class="language-sql">SELECT f.* FROM flight f JOIN flight\_stop fs ON f.to\_airport = fs.departure\_airport JOIN city c ON fs.stop\_airport = c.city\_name WHERE f.departure\_date = DATE\_ADD(NOW(), INTERVAL 1 DAY)
</code></pre>
</li>
<li><strong>Error Desciption</strong>: The model fails to correctly interpret the logic of the query, such as mismatching join conditions or incorrect fields in <code>SELECT</code> clause.</li>
</ul>
<h2>Conclusion</h2>
<p>In this project, I have explored three different approaches to the task of translating natural language instructions into SQL queries. I have experimented with fine-tuning a pre-trained encoder-decoder transformer model (T5), training a model with the same architecture from scratch, and using diverse prompt engineering techniques with a large language model (LLM). The results show that the fine-tuned T5 model achieved the best performance in terms of F1 score, while the LLM with few-shot prompting also showed promising results. The qualitative error analysis revealed that the models struggled with errors such as generating queries with non-existent columns, syntax errors, and logic errors. Future work could focus on improving the models&#x27; ability to handle these types of errors, as well as exploring more sophisticated prompt engineering techniques to guide the models towards generating more accurate SQL queries.</p></div></div></div><div class="footer_footer__zL2zm"><div class="footer_forthContainer__7lvSw"><div class="footer_contactContainer__xj3kr"><p class="footer_link__bJEVc"><a href="mailto:yufanbruce@gmail.com">Email me</a></p><div class="footer_contacts__96ifp"><p class="footer_regText__Qe69z">Or find me on...</p><p class="footer_link__bJEVc"><a href="https://www.linkedin.com/in/yufanbruce/">LinkedIn</a></p><p class="footer_link__bJEVc"><a href="https://github.com/iamyufan">GitHub</a></p><p class="footer_link__bJEVc"><a href="https://www.instagram.com/byeruuce/">Instagram</a></p><p class="footer_link__bJEVc"><a href="https://www.youtube.com/@yufanbruce">YouTube</a></p></div></div></div><p class="footer_copyright__FVm5Y">Â© 2021 â€” 2024 Yufan Zhang</p></div></main><script src="/_next/static/chunks/webpack-7dba2dcc1d41e4e6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/2b3f1035ed87a788-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/2c8f6a03b5c2a59f.css\",\"style\"]\n3:HL[\"/_next/static/css/2a1054080b77ae12.css\",\"style\"]\n4:HL[\"/_next/static/css/eea751ee46d1e33b.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"5:I[5751,[],\"\"]\n7:I[9275,[],\"\"]\n8:I[1343,[],\"\"]\n9:I[2224,[\"291\",\"static/chunks/291-de708f65a06c2e3a.js\",\"348\",\"static/chunks/app/project/layout-0ad3d92cc6aca70e.js\"],\"default\"]\na:I[1804,[\"185\",\"static/chunks/app/layout-2fb9a46769555ecd.js\"],\"default\"]\nc:I[6130,[],\"\"]\nd:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2c8f6a03b5c2a59f.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L5\",null,{\"buildId\":\"HzW1G1VIH_NNAKmkS_OIy\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/project/text2sql\",\"initialTree\":[\"\",{\"children\":[\"project\",{\"children\":[\"text2sql\",{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"project\",{\"children\":[\"text2sql\",{\"children\":[\"__PAGE__\",{},[[\"$L6\",[[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"\\\"Hmm, I wonder how LLMs can be used to translate natural language instructions into SQL queries. ðŸ¤”\\\"\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://github.com/iamyufan/text2sql\",\"children\":\"[GitHub Repo]\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"https://colab.research.google.com/drive/1taPVOrJ13UC4vnqTlMaJDrCXZYhjItHb#scrollTo=FZlMYp5PTYDE\",\"children\":\"[Colab]\"}]]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Introduction\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Writing SQL queries to solve analytical and business-critical questions is a common task for data analysts and data scientists. However, writing SQL queries can be challenging for those who are not familiar with SQL syntax. In this project, I aim to explore different solutions to the task of translating natural language instructions into SQL queries. Specifically, I experimented with three different approaches:\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Fine-tuning a pre-trained encoder-decoder transformer model, the \",[\"$\",\"a\",null,{\"href\":\"https://huggingface.co/docs/transformers/en/model_doc/t5\",\"children\":\"T5 model\"}],\".\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Training a model with the same architecture from scratch.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Using diverse prompt engineering techniques with a large language model (LLM).\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Dataset\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"For this project, I used a dataset consisting of natural language instructions and their corresponding SQL queries, which target the \",[\"$\",\"a\",null,{\"href\":\"https://github.com/iamyufan/text2sql/blob/main/data/flight_database.db\",\"children\":[\"$\",\"code\",null,{\"children\":\"flight_database.db\"}]}],\". The database schema, outlined in the \",[\"$\",\"a\",null,{\"href\":\"https://github.com/iamyufan/text2sql/blob/main/data/flight_database.schema\",\"children\":[\"$\",\"code\",null,{\"children\":\"flight_database.schema\"}]}],\" file, includes 25 tables such as \\\"airline,\\\" \\\"restriction,\\\" and \\\"flight.\\\" Each table's schema details the columns, their types, and whether they are indexed.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The text-to-SQL data is divided into training, development, and held-out test sets. Each natural language instruction (in \",[\"$\",\"code\",null,{\"children\":\".nl\"}],\" files) is paired with a ground-truth SQL query (in \",[\"$\",\"code\",null,{\"children\":\".sql\"}],\" files). Here are some examples from the training set:\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Natural Language Instruction:\"}],\" List all the flights that arrive at General Mitchell International from various cities.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"SQL Query:\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-sql\",\"children\":\"SELECT DISTINCT\\n    flight_1.flight_id\\nFROM\\n    flight flight_1,\\n    airport airport_1,\\n    airport_service airport_service_1,\\n    city city_1\\nWHERE\\n    flight_1.to_airport = airport_1.airport_code\\n    AND airport_1.airport_code = 'MKE'\\n    AND flight_1.from_airport = airport_service_1.airport_code\\n    AND airport_service_1.city_code = city_1.city_code\\n\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Natural Language Instruction:\"}],\" How much is a first-class ticket from Boston to San Francisco?\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"SQL Query:\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-sql\",\"children\":\"SELECT DISTINCT\\n    fare_1.fare_id\\nFROM\\n    fare fare_1,\\n    fare_basis fare_basis_1,\\n    flight_fare flight_fare_1,\\n    flight flight_1,\\n    airport_service airport_service_1,\\n    city city_1,\\n    airport_service airport_service_2,\\n    city city_2\\nWHERE\\n    fare_1.fare_basis_code = fare_basis_1.fare_basis_code\\n    AND fare_basis_1.class_type = 'FIRST'\\n    AND fare_1.fare_id = flight_fare_1.fare_id\\n    AND flight_fare_1.flight_id = flight_1.flight_id\\n    AND flight_1.from_airport = airport_service_1.airport_code\\n    AND airport_service_1.city_code = city_1.city_code\\n    AND city_1.city_name = 'BOSTON'\\n    AND flight_1.to_airport = airport_service_2.airport_code\\n    AND airport_service_2.city_code = city_2.city_code\\n    AND city_2.city_name = 'SAN FRANCISCO'\\n\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"To evaluate the models, I compared the generated SQL queries with the ground-truth queries using the F1 metric to ensure they return the same database records.\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Methods\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"Working with the T5 Architecture\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"I will be working with the small variant of the \",[\"$\",\"a\",null,{\"href\":\"https://arxiv.org/abs/1910.10683\",\"children\":\"T5 encoder-decoder architecture\"}],\" (Raffel et al., 2019). The encoder will ingest natural language queries (i.e., the input sequence) while the decoder will predict the corresponding SQL queries (i.e., the output sequence). My first task will be to finetune the pretrained T5 architecture while your second task will be to train the exact same architecture from scratch (i.e., from randomly initialized weights).\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"For either task, I expect simply implementing data processing with the existing T5 tokenizer and varying simple hyperparameters should lead to good baseline results. During finetuning, a common design choice is to freeze part of the model parameters (i.e., only finetune a subset of the parameters).\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Here are some design choices I have made to get the best-performing fine-tuned T5 model:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Tokenization\"}],\": Utilized the Hugging Face T5 tokenizer (\\\"google-t5/t5-small\\\") with padding and truncation enabled to ensure consistent batch processing.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Architecture\"}],\": Only the decoder's parameters were updated during fine-tuning, with the encoder's parameters frozen to preserve pre-learned contextual representations.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Hyperparameters\"}],\": Trained using a batch size of 16, across 20 epochs, with an AdamW optimizer set to a learning rate of 5e-5.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Similarly, here are the design choices I have made to train the T5 model from scratch:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Tokenization\"}],\": Used the same Hugging Face T5 tokenizer (\\\"google-t5/t5-small\\\") with padding and truncation enabled for uniform input and output processing.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Hyperparameters\"}],\": Configured with a batch size of 16, trained over 50 epochs, using an AdamW optimizer with a learning rate of 5e-5.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"Task 3: Prompting \u0026 In-context Learning with Large Language Models\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"For this task, I have experimented with in-context learning (ICL) using an LLM. I used the instruction-tuned Gemma 1.1 2B model. The LLM is frozen here, and will perform the generation task while only conditioned on the text input (prompt). I need to design prompts to experiment with zero- and few-shot prompting. In the zero-shot case, I provided instructions in the prompt, but it doesnâ€™t include examples that show the intended behaviour. In the few-shot case, I also included examples showing the intented behaviour. I have experimented with different value of \",[\"$\",\"code\",null,{\"children\":\"k\"}],\", which is the number of examples. For few-shot prompting, I also need to experiment with different ways of selecting the examples, observe how the design choice affects the performance, and how sensitive performance is to the selection of ICL examples. In the prompt, whether to also provide additional context and indications is also worth a try, for instance, about the task, the database, or details about the intended behavior.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Here is how I have designed the prompts for the zero-shot and few-shot prompting:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/projects/text2sql/prompt_design.png\",\"alt\":\"Prompt Design\"}]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"How to select the examples for few-shot prompting?\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"For selecting the examples when ( k \u003e 0 ) in my few-shot prompting, I employed a straightforward random selection approach. This method involves choosing ( k ) distinct example pairs randomly from the training dataset. Each pair consists of a natural language instruction and its corresponding SQL query.\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Evaluation\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"LLM Prompting\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"I have experimented with different value (0, 1, 3) of \",[\"$\",\"code\",null,{\"children\":\"k\"}],\" in the few-shot prompting strategy to evaluate the effectiveness of the prompts in guiding the model to generate accurate SQL queries.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Besides experimenting with the number of examples, I have also conducted ablations to evaluate the impact of different components of the prompt on the model's performance. The ablations are as follows:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Prompting Variant 3: Removed the data schema. This experiment tested the necessity of explicitly giving the model the database schema include the table names and the column names.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Prompting Variant 4: Removed the instruction \\\"Using valid SQL, answer the following questions for the tables provided above. Please do not generate more information other than the SQL queries.\\\" This experiment tested the necessity of explicitly guiding the model to restrict its responses to SQL queries only.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Prompting Variant 5: Removed the markdown SQL block indicators (```sql and ```). This ablation tested whether these formatting markers impact the model's ability to correctly format SQL queries.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The results of these ablations are shown in the table below:\"}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"children\":\"System\"}],[\"$\",\"th\",null,{\"children\":\"Query EM\"}],[\"$\",\"th\",null,{\"children\":\"F1 score\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"Full model (\",[\"$\",\"code\",null,{\"children\":\"k = 0\"}],\")\"]}],[\"$\",\"td\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"0.02789\"}]}],[\"$\",\"td\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"0.19305\"}]}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"Variant 1 (\",[\"$\",\"code\",null,{\"children\":\"k = 0\"}],\")\"]}],[\"$\",\"td\",null,{\"children\":\"0.00000\"}],[\"$\",\"td\",null,{\"children\":\"0.11779\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":[\"Variant 2 (\",[\"$\",\"code\",null,{\"children\":\"k = 3\"}],\")\"]}],[\"$\",\"td\",null,{\"children\":\"0.00643\"}],[\"$\",\"td\",null,{\"children\":\"0.13350\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Variant 3 (ablating the database schema)\"}],[\"$\",\"td\",null,{\"children\":\"0.00643\"}],[\"$\",\"td\",null,{\"children\":\"0.14559\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Variant 4 (ablating the instruction sentence)\"}],[\"$\",\"td\",null,{\"children\":\"0.02361\"}],[\"$\",\"td\",null,{\"children\":\"0.17792\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Variant 5 (ablating the formatting markers)\"}],[\"$\",\"td\",null,{\"children\":\"0.00643\"}],[\"$\",\"td\",null,{\"children\":\"0.14702\"}]]}]]}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"For ICL, I also visualized the Record F1 on the development set that the model achieved with different values of \",[\"$\",\"code\",null,{\"children\":\"k\"}],\".\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/projects/text2sql/f1.png\",\"alt\":\"ICL Performance\"}]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"T5 Model\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The tables below shows the results of the fine-tuned T5 model and the T5 model trained from scratch:\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Fine-tuned T5 model:\"}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"children\":\"System\"}],[\"$\",\"th\",null,{\"children\":\"Query EM\"}],[\"$\",\"th\",null,{\"children\":\"F1 score\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Full model\"}],[\"$\",\"td\",null,{\"children\":\"0.01716\"}],[\"$\",\"td\",null,{\"children\":\"0.62742\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Variant 1 (unfreeze the last layer)\"}],[\"$\",\"td\",null,{\"children\":\"0.01502\"}],[\"$\",\"td\",null,{\"children\":\"0.54246\"}]]}]]}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"T5 model trained from scratch:\"}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"children\":\"System\"}],[\"$\",\"th\",null,{\"children\":\"Query EM\"}],[\"$\",\"th\",null,{\"children\":\"F1 score\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Full model\"}],[\"$\",\"td\",null,{\"children\":\"0.02360\"}],[\"$\",\"td\",null,{\"children\":\"0.57552\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Variant 1 (training for 20 epochs)\"}],[\"$\",\"td\",null,{\"children\":\"0.02145\"}],[\"$\",\"td\",null,{\"children\":\"0.48829\"}]]}]]}]]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"Results on the held-out test set\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The tables below show the results of the best-performing models on the held-out test set:\"}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"children\":\"System\"}],[\"$\",\"th\",null,{\"children\":\"F1 score\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"LLM with few-shot prompting (k = 3)\"}],[\"$\",\"td\",null,{\"children\":\"0.15003\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Fine-tuned T5 model\"}],[\"$\",\"td\",null,{\"children\":\"0.61011\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"children\":\"Trained T5 model from scratch\"}],[\"$\",\"td\",null,{\"children\":\"0.52191\"}]]}]]}]]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"Qualitative Error Analysis\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I have also conducted a qualitative error analysis to identify the types of errors made by the models. Here are some examples of the errors made by the models:\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"Un-existing Column\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Relevent Models\"}],\": All models\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Example\"}],\": Column \",[\"$\",\"code\",null,{\"children\":\"departure_airport\"}],\" does not exist:\",\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-sql\",\"children\":\"SELECT * FROM flight WHERE departure_airport = 'ORD' AND arrival_airport = 'MCI' AND flight_date = '2023-06-17'\\n\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Error Desciption\"}],\": The model generates queries with columns that do not exist in the database schema.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"Syntax Error\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Relevent Models\"}],\": All models\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Example\"}],\": One extra \\\")\\\":\",\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-sql\",\"children\":\"... WHERE flight_1.from_airport = airport_service_1.airport_code AND ... AND( flight_1.arrival_time \u003e= 1600 ) AND( flight_1.flight_days = days_1.days_code ...\\n\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Error Desciption\"}],\": Syntax errors such as unmatched parentheses disrupt the SQL query structure, leading to execution failures.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"Logic Error\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Relevent Models\"}],\": All models\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Example\"}],\":\\nNatural language text: \\\"What flights are available tomorrow from Denver to Philadelphia?\\\"\\nGenerated:\",\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-sql\",\"children\":\"SELECT f.* FROM flight f JOIN flight\\\\_stop fs ON f.to\\\\_airport = fs.departure\\\\_airport JOIN city c ON fs.stop\\\\_airport = c.city\\\\_name WHERE f.departure\\\\_date = DATE\\\\_ADD(NOW(), INTERVAL 1 DAY)\\n\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"Error Desciption\"}],\": The model fails to correctly interpret the logic of the query, such as mismatching join conditions or incorrect fields in \",[\"$\",\"code\",null,{\"children\":\"SELECT\"}],\" clause.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Conclusion\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In this project, I have explored three different approaches to the task of translating natural language instructions into SQL queries. I have experimented with fine-tuning a pre-trained encoder-decoder transformer model (T5), training a model with the same architecture from scratch, and using diverse prompt engineering techniques with a large language model (LLM). The results show that the fine-tuned T5 model achieved the best performance in terms of F1 score, while the LLM with few-shot prompting also showed promising results. The qualitative error analysis revealed that the models struggled with errors such as generating queries with non-existent columns, syntax errors, and logic errors. Future work could focus on improving the models' ability to handle these types of errors, as well as exploring more sophisticated prompt engineering techniques to guide the models towards generating more accurate SQL queries.\"}]]],null],null]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"project\",\"children\",\"text2sql\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"$L9\",null,{\"children\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"project\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],\"params\":{}}],null],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__className_6b8127\",\"children\":[\"$\",\"$La\",null,{\"children\":[[\"$\",\"head\",null,{}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2a1054080b77ae12.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/eea751ee46d1e33b.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}]}]]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$Lb\"],\"globalErrorComponent\":\"$c\",\"missingSlots\":\"$Wd\"}]]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Yufan Zhang\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Yufan Zhang's personal website\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\n6:null\n"])</script></body></html>